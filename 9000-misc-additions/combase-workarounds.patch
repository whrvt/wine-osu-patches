From d2347b84e82870632452731b792a9e9e009a3b18 Mon Sep 17 00:00:00 2001
From: William Horvath <william@horvath.blog>
Date: Mon, 9 Sep 2024 00:42:17 -0700
Subject: [PATCH 1/2] HACK: combase: Retry InternalIsProcessInitialized() for 200ms
 to see if the process eventually initializes.

Trying to workaround a race condition in starting .NET applications (e.g. osu!)
---
 dlls/combase/combase.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/dlls/combase/combase.c b/dlls/combase/combase.c
index 9a68e92ff42..3c2ab23fe5d 100644
--- a/dlls/combase/combase.c
+++ b/dlls/combase/combase.c
@@ -2653,10 +2653,17 @@ HRESULT WINAPI CoGetContextToken(ULONG_PTR *token)
 {
     struct tlsdata *tlsdata;
     HRESULT hr;
+    DWORD retries;
 
     TRACE("%p\n", token);
 
-    if (!InternalIsProcessInitialized())
+    for (retries = 40; !InternalIsProcessInitialized() && retries > 0; --retries)
+    {
+        LARGE_INTEGER timeout = {.QuadPart = -5 * (ULONGLONG)10000}; /* sleep for 5ms and try again */
+        NtDelayExecution( FALSE, &timeout );
+    }
+
+    if (!retries)
     {
         ERR("apartment not initialised\n");
         return CO_E_NOTINITIALIZED;
-- 
2.46.0

From a9c4d54624d7c00b2c562071c38cce18c5e6722b Mon Sep 17 00:00:00 2001
From: William Horvath <william@horvath.blog>
Date: Tue, 10 Sep 2024 11:21:17 -0700
Subject: [PATCH 2/2] combase: Check null token earlier.

---
 dlls/combase/combase.c | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/dlls/combase/combase.c b/dlls/combase/combase.c
index d478b30beb0..b363bc771ef 100644
--- a/dlls/combase/combase.c
+++ b/dlls/combase/combase.c
@@ -2655,6 +2655,8 @@ HRESULT WINAPI CoGetContextToken(ULONG_PTR *token)
 
     TRACE("%p\n", token);
 
+    if(!token) return E_POINTER;
+
     for (retries = 40; !InternalIsProcessInitialized() && retries > 0; --retries)
     {
         LARGE_INTEGER timeout = {.QuadPart = -5 * (ULONGLONG)10000}; /* sleep for 5ms and try again */
@@ -2670,9 +2672,6 @@ HRESULT WINAPI CoGetContextToken(ULONG_PTR *token)
     if (FAILED(hr = com_get_tlsdata(&tlsdata)))
         return hr;
 
-    if (!token)
-        return E_POINTER;
-
     if (!tlsdata->context_token)
     {
         struct thread_context *context;
-- 
2.46.0

