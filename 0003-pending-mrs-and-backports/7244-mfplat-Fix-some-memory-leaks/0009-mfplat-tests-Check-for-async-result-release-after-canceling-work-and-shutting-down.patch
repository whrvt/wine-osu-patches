From c7ac34e2ff7256c8f6ae5622c67649c4f3070eaf Mon Sep 17 00:00:00 2001
From: Conor McCarthy <cmccarthy@codeweavers.com>
Date: Fri, 31 Jan 2025 15:30:47 +1000
Subject: [PATCH] mfplat/tests: Check for async result release after canceling
 work and shutting down.

---
 dlls/mfplat/tests/mfplat.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/dlls/mfplat/tests/mfplat.c b/dlls/mfplat/tests/mfplat.c
index 9a00369870f..99fe44ca98b 100644
--- a/dlls/mfplat/tests/mfplat.c
+++ b/dlls/mfplat/tests/mfplat.c
@@ -4393,8 +4393,6 @@ static void test_scheduled_items(void)
     hr = MFCancelWorkItem(key2);
     ok(hr == S_OK, "Failed to cancel item, hr %#lx.\n", hr);
 
-    IMFAsyncResult_Release(result);
-
     hr = MFScheduleWorkItem(&callback->IMFAsyncCallback_iface, NULL, -5000, &key);
     ok(hr == S_OK, "Failed to schedule item, hr %#lx.\n", hr);
 
@@ -4404,6 +4402,13 @@ static void test_scheduled_items(void)
     hr = MFShutdown();
     ok(hr == S_OK, "Failed to shut down, hr %#lx.\n", hr);
 
+    Sleep(20);
+    /* An callback invocation with RTWQ_E_OPERATION_CANCELLED may have been pending
+     * when MFShutdown() was called. Release depends upon its execution. */
+    refcount = IMFAsyncResult_Release(result);
+    flaky_wine
+    ok(refcount == 0, "Unexpected refcount %lu.\n", refcount);
+
     IMFAsyncCallback_Release(&callback->IMFAsyncCallback_iface);
 }
 
-- 
GitLab

