From 576b5c9fedd5fb04b2b6a5cd89bc61778508fb9a Mon Sep 17 00:00:00 2001
From: Jinoh Kang <jinoh.kang.kr@gmail.com>
Date: Thu, 13 Feb 2025 06:46:30 +0900
Subject: [PATCH] ntdll: Register module dependency for export forwarders
 regardless of whether the dependency is already loaded.

Prepare for generalization to imports from DLLs.

Calling add_module_dependency() multiple times for the same dependency
edge no longer bloats memory usage.
---
 dlls/ntdll/loader.c | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/dlls/ntdll/loader.c b/dlls/ntdll/loader.c
index 7424b1898a2..7ecc17e7cae 100644
--- a/dlls/ntdll/loader.c
+++ b/dlls/ntdll/loader.c
@@ -980,15 +980,17 @@ static FARPROC find_forwarded_export( HMODULE module, const char *forward, LPCWS
     }
     else
     {
-        if (wm_owned_ref && !(wm->ldr.Flags & LDR_DONT_RESOLVE_REFS))
+        if (!(wm->ldr.Flags & LDR_DONT_RESOLVE_REFS) &&
+            wm->ldr.DdagNode != node_ntdll && wm->ldr.DdagNode != node_kernel32)
         {
             if (!imports_fixup_done && importer)
             {
                 /* Prepare for the callee stealing the reference */
-                wm_owned_ref = FALSE;
+                if (wm_owned_ref) wm_owned_ref = FALSE;
+                else if (wm->ldr.LoadCount != -1) wm->ldr.LoadCount++;
                 add_module_dependency( importer->ldr.DdagNode, wm->ldr.DdagNode );
             }
-            else if (process_attach( wm->ldr.DdagNode, NULL ) != STATUS_SUCCESS)
+            else if (wm_owned_ref && process_attach( wm->ldr.DdagNode, NULL ) != STATUS_SUCCESS)
             {
                 proc = NULL;
             }
-- 
GitLab

