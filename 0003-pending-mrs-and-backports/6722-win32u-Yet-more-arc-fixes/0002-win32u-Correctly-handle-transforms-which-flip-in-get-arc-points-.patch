From 32cb2737c4ea8bfcaf41609fbd78849311d709ca Mon Sep 17 00:00:00 2001
From: Elizabeth Figura <zfigura@codeweavers.com>
Date: Tue, 22 Oct 2024 13:24:13 -0500
Subject: [PATCH] win32u: Correctly handle transforms which flip in
 get_arc_points().

---
 dlls/win32u/dibdrv/graphics.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/dlls/win32u/dibdrv/graphics.c b/dlls/win32u/dibdrv/graphics.c
index e7648cb2596..64d58ac6ed7 100644
--- a/dlls/win32u/dibdrv/graphics.c
+++ b/dlls/win32u/dibdrv/graphics.c
@@ -316,6 +316,12 @@ static int get_arc_points( DC *dc, int arc_dir, const RECT *rect, POINT start, P
 
     count = generate_ellipse_top_half( dc, width, height, points );
 
+    /* The ellipse is always generated counterclockwise from the origin.
+     * This means our points will essentially be backwards if the world
+     * transform includes a flip. Swap the arc direction to correct for this. */
+    if (dc->xformWorld2Vport.eM11 * dc->xformWorld2Vport.eM22 < dc->xformWorld2Vport.eM12 * dc->xformWorld2Vport.eM21)
+        arc_dir = (arc_dir == AD_CLOCKWISE ? AD_COUNTERCLOCKWISE : AD_CLOCKWISE);
+
     /* Transform the start and end, but do not translate them, so that they
      * remain relative to the ellipse center. */
     lp_to_dp_no_translate( dc, &start );
-- 
GitLab

