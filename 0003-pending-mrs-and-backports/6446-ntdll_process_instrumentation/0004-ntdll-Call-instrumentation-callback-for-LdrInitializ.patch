From 7ddf3cd17cc9632843b1dfa8b8e468aa2c025d98 Mon Sep 17 00:00:00 2001
From: Paul Gofman <pgofman@codeweavers.com>
Date: Wed, 4 Sep 2024 16:21:12 -0600
Subject: [PATCH 4/5] ntdll: Call instrumentation callback for
 LdrInitializeThunk on x64.

---
 dlls/ntdll/tests/exception.c    | 2 +-
 dlls/ntdll/unix/signal_x86_64.c | 6 ++++++
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/dlls/ntdll/tests/exception.c b/dlls/ntdll/tests/exception.c
index 12c99c9975f..e27bae09826 100644
--- a/dlls/ntdll/tests/exception.c
+++ b/dlls/ntdll/tests/exception.c
@@ -5643,7 +5643,7 @@ static void test_instrumentation_callback(void)
     {
         if (data.call_data[i].r10 == pLdrInitializeThunk) break;
     }
-    todo_wine ok( i < data.call_count, "LdrInitializeThunk not found.\n" );
+    ok( i < data.call_count, "LdrInitializeThunk not found.\n" );
 
     init_instrumentation_data( &curr_data );
     SetEvent( instrumentation_callback_thread_wait );
diff --git a/dlls/ntdll/unix/signal_x86_64.c b/dlls/ntdll/unix/signal_x86_64.c
index 8aab736d63a..d811d014fd4 100644
--- a/dlls/ntdll/unix/signal_x86_64.c
+++ b/dlls/ntdll/unix/signal_x86_64.c
@@ -2526,6 +2526,7 @@ void call_init_thunk( LPTHREAD_START_ROUTINE entry, void *arg, BOOL suspend, TEB
     struct amd64_thread_data *thread_data = (struct amd64_thread_data *)&teb->GdiTebBatch;
     CONTEXT *ctx, context = { 0 };
     I386_CONTEXT *wow_context;
+    void *callback;
 
     thread_data->syscall_table = KeServiceDescriptorTable;
     thread_data->xstate_features_mask = xstate_supported_features_mask;
@@ -2604,6 +2605,11 @@ void call_init_thunk( LPTHREAD_START_ROUTINE entry, void *arg, BOOL suspend, TEB
     frame->syscall_flags = syscall_flags;
     frame->syscall_cfa   = syscall_cfa;
     frame->instrumentation_callback = &instrumentation_callback;
+    if ((callback = instrumentation_callback))
+    {
+        frame->r10 = frame->rip;
+        frame->rip = (ULONG64)callback;
+    }
 
     pthread_sigmask( SIG_UNBLOCK, &server_block_set, NULL );
     __wine_syscall_dispatcher_return( frame, 0 );
-- 
2.46.0

