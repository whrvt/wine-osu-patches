From 5fffc4918176447d1f5bc0a6ea9df00627477d90 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Tue, 17 Sep 2024 17:20:41 +0200
Subject: [PATCH] win32u: Avoid leaking window surface references with DPI
 scaling.

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=57199
---
 dlls/win32u/dce.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/dlls/win32u/dce.c b/dlls/win32u/dce.c
index 3b8bc699017..2faf73f2f53 100644
--- a/dlls/win32u/dce.c
+++ b/dlls/win32u/dce.c
@@ -302,11 +302,13 @@ void create_window_surface( HWND hwnd, BOOL create_layered, const RECT *surface_
     {
         struct scaled_surface *surface = get_scaled_surface( previous );
         scaled_surface_set_target( surface, driver_surface, monitor_dpi );
+        window_surface_release( driver_surface );
         return;
     }
     if (previous) window_surface_release( previous );
 
     *window_surface = scaled_surface_create( hwnd, surface_rect, dpi, monitor_dpi, driver_surface );
+    window_surface_release( driver_surface );
 }
 
 struct window_surface *get_driver_window_surface( struct window_surface *surface, UINT monitor_dpi )
-- 
GitLab

