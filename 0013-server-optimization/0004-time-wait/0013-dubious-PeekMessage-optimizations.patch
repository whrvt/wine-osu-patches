From 5d424cc8b82b47bf3e321f7d10f7a137ed7d30e6 Mon Sep 17 00:00:00 2001
From: William Horvath <william@horvath.blog>
Date: Wed, 29 Jan 2025 00:11:01 -0800
Subject: [PATCH] dubious PeekMessage 'optimizations'

---
 dlls/ntdll/unix/sync.c | 22 ++++++----------------
 dlls/win32u/message.c  |  2 +-
 2 files changed, 7 insertions(+), 17 deletions(-)

diff --git a/dlls/ntdll/unix/sync.c b/dlls/ntdll/unix/sync.c
index 2a087cfb8ed..de90272d387 100644
--- a/dlls/ntdll/unix/sync.c
+++ b/dlls/ntdll/unix/sync.c
@@ -2733,22 +2733,15 @@ NTSTATUS WINAPI NtSignalAndWaitForSingleObject( HANDLE signal, HANDLE wait,
  */
 NTSTATUS WINAPI NtYieldExecution(void)
 {
-#ifdef HAVE_SCHED_YIELD
-#ifdef RUSAGE_THREAD
-    struct rusage u1, u2;
-    int ret;
-
-    ret = getrusage( RUSAGE_THREAD, &u1 );
-#endif
-    for (int i=0;i<10;i++) sched_yield();
-#ifdef RUSAGE_THREAD
-    if (!ret) ret = getrusage( RUSAGE_THREAD, &u2 );
-    if (!ret && u1.ru_nvcsw == u2.ru_nvcsw && u1.ru_nivcsw == u2.ru_nivcsw) return STATUS_NO_YIELD_PERFORMED;
-#endif
-    return STATUS_SUCCESS;
-#else
-    return STATUS_NO_YIELD_PERFORMED;
-#endif
+    static unsigned int count = 0;
+    YieldProcessor();
+    count = (count + 1) % 100;
+    if (!count)
+    {
+        NtFlushProcessWriteBuffers();
+        return STATUS_SUCCESS;
+    }
+    return STATUS_NO_YIELD_PERFORMED;
 }
 
 
diff --git a/dlls/win32u/message.c b/dlls/win32u/message.c
index 902610c44ba..bdd242adf01 100644
--- a/dlls/win32u/message.c
+++ b/dlls/win32u/message.c
@@ -3120,7 +3120,7 @@ static inline LONGLONG get_driver_check_time(void)
 {
     LARGE_INTEGER counter, freq;
     NtQueryPerformanceCounter( &counter, &freq );
-    return counter.QuadPart * 8000 / freq.QuadPart; /* 8kHz */
+    return counter.QuadPart * 12000 / freq.QuadPart; /* 12kHz */
 }
 
 /* check for driver events if we detect that the app is not properly consuming messages */
-- 
2.48.1

